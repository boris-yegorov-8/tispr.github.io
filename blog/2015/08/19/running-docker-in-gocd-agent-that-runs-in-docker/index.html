
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Running Docker in a GoCD Agent That Runs in a Docker - tispr Engineering</title>
  <meta name="author" content="BuddyHopp, Inc.">

  
  <meta name="description" content="Setting up Continuous Delivery may be challenging. However, it is definitely worth the time and resource investment,
if you want to release often, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://engineering.tispr.com/blog/2015/08/19/running-docker-in-gocd-agent-that-runs-in-docker/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="tispr Engineering" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-54620739-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tispr Engineering</a></h1>
  
    <h2>Engineering Team blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="engineering.tispr.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://tispr.com/careers/" target="_blank">Careers</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Running Docker in a GoCD Agent That Runs in a Docker</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-19T02:08:27+00:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:08 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Setting up Continuous Delivery may be challenging. However, it is definitely worth the time and resource investment,
if you want to release often, maintain a high quality of released products and have full control over the complete process.
<a href="http://www.go.cd/">GoCD</a> is built on a pipelines concept described in <a href="http://martinfowler.com/books/continuousDelivery.html">Continuous Delivery book</a>.
<a href="https://www.docker.com/">Docker</a> greatly fits into the concept, because it solves the problem of packaging applications with all required dependencies and configurations into a standardized container unit.
A common build pipeline will use a Dockerfile as an input, create an image and publish it to a Docker registry.
A common deploy pipeline will use a Docker registry image as an input and deploy it to a proper environment when it is updated.</p>

<p>GoCD in its basic setup is distributed and has a Server and one or more Agents, which are running actual Jobs and Tasks.
The Server can be customized by adding new plugins, or by setting up a backed-up pipeline configuration.
The Agents may have different resources to run different types of jobs, i.e. separate Agents to build java and node.js projects.
Same as for any other software deliverable, packaging GoCD Server and Agents into Docker containers simplifies their deployment and maintainability.
One of the challenges in this setup is running your existing Docker pipelines in an Agent, which is running in a Docker container.</p>

<p>So, in brief, you may find this article interesting, if you:</p>

<ul>
<li>use GoCD;</li>
<li>use Docker;</li>
<li>use GoCD to build Docker images;</li>
<li>run GoCD agents in a Docker.</li>
</ul>


<p>The most important part of this setup is a <a href="https://hub.docker.com/r/jpetazzo/dind/">Docker-in-Docker</a>, which we use as a base image:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM jpetazzo/dind</span></code></pre></td></tr></table></div></figure>


<p>To run a GoCD agent in a Docker, we need to run several processes in one container. For this let&rsquo;s use <a href="http://docs.docker.com/articles/using_supervisord/">supervisor</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>RUN apt-get -y install supervisor
</span><span class='line'>ADD supervisord.conf /etc/supervisor/conf.d/supervisord.conf
</span><span class='line'>CMD ["/usr/bin/supervisord"]</span></code></pre></td></tr></table></div></figure>


<p>The configuration file for the supervisor will contain a section per each process, including the supervisor itself:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[supervisord]
</span><span class='line'>nodaemon=true
</span><span class='line'>
</span><span class='line'>[program:docker]
</span><span class='line'>priority=10
</span><span class='line'>command=wrapdocker
</span><span class='line'>
</span><span class='line'>[program:gocdagent]
</span><span class='line'>priority=20
</span><span class='line'>command=/bin/bash -c "/etc/init.d/go-agent start"</span></code></pre></td></tr></table></div></figure>


<p>Some additional tweaks may be required to run your GoCD agent properly. One of them is setting <code>GO_SERVER</code> in your agent configuration. Let&rsquo;s assume that it is available as an environment variable with the same name:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo export GO_SERVER=$GO_SERVER &gt;&gt; /etc/default/go-agent</span></code></pre></td></tr></table></div></figure>


<p>Another update will allow to run <code>sudo docker</code> without an interactive password prompt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo go ALL=NOPASSWD: /usr/bin/docker &gt;&gt; /etc/sudoers</span></code></pre></td></tr></table></div></figure>


<p>And the complete GoCD command will look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>command=/bin/bash -c "echo export GO_SERVER=$GO_SERVER &gt;&gt; /etc/default/go-agent && echo go ALL=NOPASSWD: /usr/bin/docker &gt;&gt; /etc/sudoers && /etc/init.d/go-agent start"</span></code></pre></td></tr></table></div></figure>


<p>You can check the complete <a href="https://github.com/tispr/docker-gocd/tree/master/gocd-agent-dind/">Dockerfile</a> and start playing
with existing image by pulling <a href="https://hub.docker.com/r/tispr/gocd-agent-dind/">tispr/gocd-agent-dind</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker pull tispr/gocd-agent-dind</span></code></pre></td></tr></table></div></figure>


<p>Now nothing stops you from setting up a GoCD pipeline to manage dockerized GoCD Server and GoCD Agents.</p>

<h2>References</h2>

<ul>
<li>Docker in Docker: <a href="https://github.com/jpetazzo/dind/">https://github.com/jpetazzo/dind/</a></li>
<li>Go Continuous Delivery: <a href="http://www.go.cd/">http://www.go.cd/</a></li>
<li>Jenkins DIND: <a href="https://github.com/killercentury/docker-jenkins-dind">https://github.com/killercentury/docker-jenkins-dind</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alex Voitau</span></span>

      




<time class='entry-date' datetime='2015-08-19T02:08:27+00:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:08 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/continuous-delivery/'>continuous delivery</a>, <a class='category' href='/blog/categories/docker/'>docker</a>, <a class='category' href='/blog/categories/gocd/'>gocd</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://engineering.tispr.com/blog/2015/08/19/running-docker-in-gocd-agent-that-runs-in-docker/" data-via="tisprEng" data-counturl="http://engineering.tispr.com/blog/2015/08/19/running-docker-in-gocd-agent-that-runs-in-docker/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/08/02/how-to-display-build-number-and-version-on-an-ios-app-icon/" title="Previous Post: How to display build number and version on an iOS app icon">&laquo; How to display build number and version on an iOS app icon</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/08/19/running-docker-in-gocd-agent-that-runs-in-docker/">Running Docker in a GoCD Agent That Runs in a Docker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/02/how-to-display-build-number-and-version-on-an-ios-app-icon/">How to Display Build Number and Version on an iOS App Icon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/22/blogging-with-octopress-editorial-workflow/">Blogging With Octopress: Editorial Workflow</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/tispr">@tispr</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tispr',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="twitterOct">
    <h1 style="margin-bottom: 0.4em"> Tweets </h1>
    <a class="twitter-timeline"
       data-dnt="true" href="https://twitter.com/tisprEng"
       data-widget-id="627176829711880193">

        Tweets by @tisprEng
    </a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - BuddyHopp, Inc. -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tispreng';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://engineering.tispr.com/blog/2015/08/19/running-docker-in-gocd-agent-that-runs-in-docker/';
        var disqus_url = 'http://engineering.tispr.com/blog/2015/08/19/running-docker-in-gocd-agent-that-runs-in-docker/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
